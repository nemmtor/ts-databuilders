name: Continous Integration

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

jobs:
  test:
    name: Unit and integration tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup project
        uses: ./.github/actions/setup

      - name: Run tests
        run: pnpm test:coverage

  static-analysis:
    name: Static analysis
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        check: [format, lint, check-actions, check-types, check-knip, check-dep]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup project
        uses: ./.github/actions/setup

      - name: Run ${{ matrix.check }}
        run: pnpm ${{ matrix.check }}

  gitleaks:
    name: Leaked secrets check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
            # https://github.com/gitleaks/gitleaks/issues/1306
            fetch-depth: 0

      - name: Run gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  audit:
    name: Audit installed dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup project
        uses: ./.github/actions/setup

      - name: Run audit
        run: pnpm audit --ignore GHSA-5j98-mcp5-4vw2

  check-commits:
    name: Commits naming
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
            fetch-depth: 0

      - name: Setup project
        uses: ./.github/actions/setup

      - name: Check PR commits
        run: pnpm check-commits --from ${{ github.event.pull_request.base.sha }} --to ${{ github.event.pull_request.head.sha }} --verbose
